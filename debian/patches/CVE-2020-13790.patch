From: Markus Koschany <apo@debian.org>
Date: Mon, 31 Aug 2020 17:38:35 +0200
Subject: CVE-2020-13790

Bug-Debian: https://bugs.debian.org/962829
Origin: https://github.com/libjpeg-turbo/libjpeg-turbo/commit/1bfb0b5247f4fc8f6677639781ce468543490216
---
 rdppm.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/rdppm.c b/rdppm.c
index 59da2bb..f812777 100644
--- a/rdppm.c
+++ b/rdppm.c
@@ -19,6 +19,7 @@
  * the file is indeed PPM format).
  */
 
+#define JPEG_INTERNALS
 #include "cdjpeg.h"		/* Common decls for cjpeg/djpeg applications */
 
 #ifdef PPM_SUPPORTED
@@ -423,7 +424,8 @@ start_input_ppm (j_compress_ptr cinfo, cjpeg_source_ptr sinfo)
     /* On 16-bit-int machines we have to be careful of maxval = 65535 */
     source->rescale = (JSAMPLE *)
       (*cinfo->mem->alloc_small) ((j_common_ptr) cinfo, JPOOL_IMAGE,
-				  (size_t) (((long) maxval + 1L) * SIZEOF(JSAMPLE)));
+                                  (size_t) (((long) MAX(maxval, 255) + 1L) *
+                                     sizeof(JSAMPLE)));
     half_maxval = maxval / 2;
     for (val = 0; val <= (INT32) maxval; val++) {
       /* The multiplication here must be done in 32 bits to avoid overflow */
